# –†–µ–∑—é–º–µ —É–ª—É—á—à–µ–Ω–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ª–æ–≥–æ–≤ –≤ ELK

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ

### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è –≤ –ª–æ–≥–∞—Ö

**LoggingContextFilter** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ª—è –≤ –∫–∞–∂–¥—ã–π –ª–æ–≥:

- **`bookId`** - ID –∫–Ω–∏–≥–∏ (–∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ URL `/api/v1/books/{id}`)
- **`userId`** - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ SecurityContext)
- **`requestId`** - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞
- **`requestPath`** - –ü—É—Ç—å HTTP –∑–∞–ø—Ä–æ—Å–∞
- **`requestMethod`** - HTTP –º–µ—Ç–æ–¥ (GET, POST, etc.)
- **`ipAddress`** - IP –∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞ (—Å —É—á–µ—Ç–æ–º –ø—Ä–æ–∫—Å–∏ –∏ load balancer)
- **`userAgent`** - –ë—Ä–∞—É–∑–µ—Ä/–∫–ª–∏–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **`responseTime`** - –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
- **`statusCode`** - HTTP —Å—Ç–∞—Ç—É—Å –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞ (200, 404, 500, etc.)

### 2. –Ø–≤–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ MDC –ø–æ–ª–µ–π

–í `logback-spring.xml` –¥–æ–±–∞–≤–ª–µ–Ω–æ:
```xml
<includeMdcKeyPrefix>bookId,userId,requestPath,requestMethod,requestId</includeMdcKeyPrefix>
```

–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤—Å–µ MDC –ø–æ–ª—è –ø–æ–ø–∞–¥—É—Ç –≤ JSON –ª–æ–≥–∏.

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ MDC

–§–∏–ª—å—Ç—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç MDC –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è "—É—Ç–µ—á–∫—É" –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏.

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ü—Ä–æ—Å—Ç–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è** - –≤–º–µ—Å—Ç–æ –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–µ–∫—Å—Ç—É –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è
2. **–¢—Ä–µ–π—Å–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤** - `requestId` –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–¥–∏—Ç—å –≤–µ—Å—å –ø—É—Ç—å –∑–∞–ø—Ä–æ—Å–∞
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—è–º –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –ø–æ —Ç–µ–∫—Å—Ç—É
4. **–¢–æ—á–Ω–æ—Å—Ç—å** - –º–µ–Ω—å—à–µ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π –ø—Ä–∏ –ø–æ–∏—Å–∫–µ

## üîç –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ Kibana

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–Ω–∏–≥–µ:
```
bookId: 30
```

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:
```
userId: 5
```

### –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è:
```
bookId: 30 and userId: 5
```

### –¢—Ä–µ–π—Å–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–∞:
```
requestId: "550e8400-e29b-41d4-a716-446655440000"
```

### –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –∫–Ω–∏–≥–∏:
```
bookId: 30 and level: "ERROR"
```

### –ü–æ–∏—Å–∫ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:
```
responseTime > 1000
```

### –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫ –ø–æ —Å—Ç–∞—Ç—É—Å –∫–æ–¥—É:
```
statusCode >= 400
```

### –ê–Ω–∞–ª–∏–∑ –ø–æ IP –∞–¥—Ä–µ—Å—É:
```
ipAddress: "192.168.1.100"
```

### –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑:
```
bookId: 30 and responseTime > 1000 and statusCode: 200
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–¢–∏–ø—ã –ø–æ–ª–µ–π –≤ Elasticsearch**: –ü–æ–ª—è `bookId` –∏ `userId` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–∏–ø–∞ `keyword` (–Ω–µ `text`) –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏. Elasticsearch –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç —Ç–∏–ø –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏.

2. **–ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞**: –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

3. **–†–∞–±–æ—Ç–∞ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**: –î–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª–µ `userId` –±—É–¥–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ).

4. **–†–∞–±–æ—Ç–∞ –±–µ–∑ bookId**: –î–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∫–Ω–∏–≥–∞–º–∏, –ø–æ–ª–µ `bookId` –±—É–¥–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å.

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

1. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è**:
   - `sessionId` - –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–π
   - `ipAddress` - IP –∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞
   - `userAgent` - –±—Ä–∞—É–∑–µ—Ä/–∫–ª–∏–µ–Ω—Ç
   - `responseTime` - –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞

2. **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ Kibana**:
   - Dashboard —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –ø–æ –∫–Ω–∏–≥–∞–º
   - Dashboard —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ê–ª–µ—Ä—Ç—ã –Ω–∞ –æ—à–∏–±–∫–∏

3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏**:
   - –ü–µ—Ä–µ–¥–∞—á–∞ `requestId` –º–µ–∂–¥—É –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏
   - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç—Ä–µ–π—Å–∏–Ω–≥ —á–µ—Ä–µ–∑ Zipkin/Jaeger

## üìù –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã

1. `main-app/src/main/java/.../filter/LoggingContextFilter.java` - –Ω–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä
2. `main-app/src/main/resources/logback-spring.xml` - –¥–æ–±–∞–≤–ª–µ–Ω–æ `includeMdcKeyPrefix`
3. `analytics-service/src/main/resources/logback-spring.xml` - –¥–æ–±–∞–≤–ª–µ–Ω–æ `includeMdcKeyPrefix`
4. `main-app/src/main/java/.../security/SecurityConfig.java` - –¥–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ —Ñ–∏–ª—å—Ç—Ä–µ

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

–ü–æ—Å–ª–µ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:

1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
2. –û—Ç–∫—Ä–æ–π—Ç–µ Kibana Discover
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–ª—è `bookId`, `userId`, `requestId` –ø–æ—è–≤–∏–ª–∏—Å—å –≤ —Å–ø–∏—Å–∫–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–ª–µ–π
4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ –ø–æ —ç—Ç–∏–º –ø–æ–ª—è–º

–ï—Å–ª–∏ –ø–æ–ª—è –Ω–µ –ø–æ—è–≤–∏–ª–∏—Å—å:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω–æ —Å –Ω–æ–≤—ã–º –∫–æ–¥–æ–º
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Logstash –ø–æ–ª—É—á–∞–µ—Ç –ª–æ–≥–∏ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Logstash)
