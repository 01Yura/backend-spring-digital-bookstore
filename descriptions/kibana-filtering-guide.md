# Руководство по фильтрации логов в Kibana

## Текущий способ фильтрации (по тексту сообщений)

### Фильтрация по номеру книги (bookId)

В Kibana Discover используйте KQL (Kibana Query Language) в строке поиска:

**Примеры запросов:**

1. **Найти все логи, связанные с книгой ID 30:**
   ```
   message: "bookId: 30" or message: "bookId:30" or message: "/api/v1/books/30"
   ```

2. **Найти все логи, связанные с книгой ID 117:**
   ```
   message: "bookId: 117" or message: "bookId:117" or message: "/api/v1/books/117"
   ```

3. **Найти логи просмотра книги:**
   ```
   message: "BookViewEvent" and message: "bookId: 30"
   ```

4. **Найти логи скачивания книги:**
   ```
   message: "BOOK_DOWNLOAD" and message: "bookId: 30"
   ```

### Фильтрация по пользователю (userId)

1. **Найти все логи, связанные с пользователем ID 5:**
   ```
   message: "userId: 5" or message: "userId:5"
   ```

2. **Найти логи покупок пользователя:**
   ```
   message: "userId: 5" and message: "purchase"
   ```

### Комбинированная фильтрация

1. **Найти логи для конкретной книги и пользователя:**
   ```
   message: "bookId: 30" and message: "userId: 5"
   ```

2. **Найти логи просмотров книги определенным пользователем:**
   ```
   message: "BookViewEvent" and message: "bookId: 30" and message: "userId: 5"
   ```

### Фильтрация по типу события

1. **Все события просмотра книг:**
   ```
   message: "BookViewEvent" or message: "BOOK_VIEW"
   ```

2. **Все события скачивания:**
   ```
   message: "BOOK_DOWNLOAD"
   ```

3. **Все события покупок:**
   ```
   message: "BOOK_PURCHASE" or message: "purchase"
   ```

## Улучшенный способ (после добавления структурированных полей)

После добавления полей `bookId` и `userId` в логи через MDC, фильтрация стала проще:

### Простые запросы:

1. **Найти все логи для книги ID 30:**
   ```
   bookId: 30
   ```

2. **Найти все логи для пользователя ID 5:**
   ```
   userId: 5
   ```

3. **Найти логи для конкретной книги и пользователя:**
   ```
   bookId: 30 and userId: 5
   ```

### Комбинированные запросы:

1. **Все ошибки для книги 30:**
   ```
   level: "ERROR" and bookId: 30
   ```

2. **Все логи просмотра книги 30:**
   ```
   message: "BookViewEvent" and bookId: 30
   ```

3. **Все действия пользователя 5 с книгой 30:**
   ```
   userId: 5 and bookId: 30
   ```

4. **Все логи для определенного пути запроса:**
   ```
   requestPath: "/api/v1/books/30" and userId: 5
   ```

### Поля, доступные для фильтрации:

- `bookId` - ID книги (извлекается из URL)
- `userId` - ID пользователя (извлекается из SecurityContext)
- `requestPath` - путь запроса
- `requestMethod` - HTTP метод (GET, POST, etc.)
- `service` - название сервиса (main-app или analytics-service)
- `level` - уровень логирования (INFO, ERROR, WARN, DEBUG)
- `message` - текст сообщения
- `logger_name` - имя логгера

## Использование фильтров в Kibana

1. **Через строку поиска (KQL):**
   - Введите запрос в строке поиска вверху страницы
   - Используйте операторы: `and`, `or`, `not`
   - Для точного совпадения: `message: "bookId: 30"`

2. **Через фильтры (Add filter):**
   - Нажмите "Add filter" под строкой поиска
   - Выберите поле (например, `message`)
   - Выберите оператор (contains, is, is not, etc.)
   - Введите значение

3. **Сохранение фильтров:**
   - После настройки фильтров нажмите "Save" в правом верхнем углу
   - Сохраните как Saved Search для повторного использования

## Примеры сложных запросов

1. **Все ошибки, связанные с книгой 30:**
   ```
   level: "ERROR" and message: "bookId: 30"
   ```

2. **Все логи за последний час для книги 30:**
   - Установите временной диапазон: "Last 1 hour"
   - Добавьте фильтр: `message: "bookId: 30"`

3. **Логи от конкретного сервиса для книги:**
   ```
   service: "main-app" and message: "bookId: 30"
   ```

4. **Все действия пользователя 5:**
   ```
   message: "userId: 5"
   ```
